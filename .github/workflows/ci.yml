name: CI

on:
  push:
    branches: [ 'main', 'master' ]
  pull_request:
    branches: [ 'main', 'master' ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13", "3.14"]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_payout_user
          POSTGRES_PASSWORD: test_payout_password
          POSTGRES_DB: test_payout_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_payout_user -d test_payout_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    env:
      # Django settings
      DJANGO_SETTINGS_MODULE: app.settings_tests
      SECRET_KEY: test-secret-key-12345-for-ci
      ALLOWED_HOSTS: localhost,127.0.0.1,0.0.0.0
      DEBUG: "False"

      # Database connection
      DB_NAME: test_payout_db
      DB_USER: test_payout_user
      DB_PASSWORD: test_payout_password
      DB_HOST: 127.0.0.1
      DB_PORT: 5432

      # PostgreSQL connection string (для удобства)
      DATABASE_URL: postgresql://test_payout_user:test_payout_password@127.0.0.1:5432/test_payout_db

      # Python/UV оптимизации
      PYTHONUNBUFFERED: "1"
      UV_NO_CACHE: "false"

    steps:
      # 1. Получаем код
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Полный history для coverage отчетов

      # 2. Устанавливаем uv и Python
      - name: Setup uv with Python
        uses: astral-sh/setup-uv@v3
        with:
          python-version: ${{ matrix.python-version }}
          # Автоматическое кэширование на основе uv.lock
          enable-cache: true
          cache-dependency-glob: "uv.lock"
          # Оптимизация для CI
          cache-http: true
          cache-wheels: true

      # 3. Устанавливаем системные зависимости
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpq-dev \
            build-essential \
            curl \
            git
        shell: bash

      # 4. Ожидаем готовности PostgreSQL
      - name: Wait for PostgreSQL to be ready
        run: |
          timeout=30
          counter=0
          until pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" || [ $counter -eq $timeout ]; do
            echo "Waiting for PostgreSQL... ($counter/$timeout)"
            sleep 1
            ((counter++))
          done
          
          if [ $counter -eq $timeout ]; then
            echo "PostgreSQL not ready after $timeout seconds"
            exit 1
          fi
          
          echo "PostgreSQL is ready!"
          
          # Проверяем доступ к БД
          PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1;" || echo "Database connection test failed"
        shell: bash

      # 5. Устанавливаем зависимости проекта через uv
      - name: Install Python dependencies
        run: |
          # Проверяем версии
          uv --version
          python --version
          
          # Синхронизируем зависимости (используем frozen mode для consistency)
          uv sync \
            --extra dev \
            --frozen \
            --no-install-project \
            --compile-bytecode
          
          # Устанавливаем проект в editable mode
          uv pip install -e .
        shell: bash

      # 6. Проверяем структуру проекта
      - name: Verify project structure
        run: |
          echo "Project structure:"
          ls -la
          
          echo "Virtual environment:"
          uv venv --path
          
          echo "Installed packages:"
          uv pip list
        shell: bash

      # 7. Запускаем линтер (ruff)
      - name: Run Ruff linter
        run: uv run ruff check .
        shell: bash

      # 8. Проверяем форматирование
      - name: Check code formatting
        run: uv run ruff format --check .
        shell: bash

      # 9. Запускаем тесты с покрытием
      - name: Run tests with pytest
        run: |
          uv run pytest \
            --maxfail=1 \
            --disable-warnings \
            -v \
            --cov=payouts \
            --cov-report=xml \
            --cov-report=term \
            --cov-fail-under=80 \
            --junitxml=junit.xml
        shell: bash

      # 10. Загружаем артефакты (coverage отчеты)
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: |
            coverage.xml
            junit.xml

      # 11. Загружаем отчеты в Codecov
      - name: Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: python-${{ matrix.python-version }}